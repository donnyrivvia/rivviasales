'use client';

import Link from "next/link";
import { useState, useEffect, useMemo } from "react";
import WipeReveal from "./WipeReveal";

// ========================================
// GRID CONTROLS - Adjust these values
// ========================================
const SQUARE_SIZE = 4;        // Size of each square in pixels
const GRID_SPACING = 6;       // Space between squares (center to center)
const SQUARE_OPACITY = 0.1;   // Opacity of squares (0-1)

// Market locations removed - map now serves as background visual only

// USA map path data (scaled to fit 800x500 viewBox)
const USA_PATH_DATA = "M137.457 0.566508C137.104 1.13851 137.547 3.02052 138.441 4.74952C139.736 7.25452 139.901 9.14052 139.252 14.0295C138.803 17.4035 138.428 23.9895 138.417 28.6645C138.401 35.5445 138.111 37.1645 136.897 37.1645C135.947 37.1645 135.052 35.6065 134.455 32.9145C133.415 28.2235 132.51 27.6505 130.897 30.6645C129.227 33.7855 127.065 33.0755 126.331 29.1645C125.795 26.3095 125.229 25.6645 123.253 25.6645C118.005 25.6645 105.4 19.7565 99.5799 14.5695C92.3009 8.08251 90.1899 8.32252 86.3999 16.0685L83.7569 21.4705L85.8269 25.5275C88.2709 30.3175 88.3629 32.4375 86.4969 40.8525C84.0119 52.0595 83.6859 57.2445 85.3809 58.6505C87.5669 60.4655 87.2529 62.2015 84.3969 64.0725C81.6309 65.8855 81.2779 67.7005 83.1199 70.6505C84.1789 72.3455 83.9099 73.0555 81.1199 75.9345C79.3469 77.7635 77.8969 79.7635 77.8969 80.3795C77.8969 80.9955 79.5849 82.3245 81.6469 83.3325C85.5289 85.2295 87.9219 89.7035 84.2479 88.1965C78.3319 85.7705 79.3279 84.3955 70.8719 106.665C68.2609 113.54 61.0489 130.07 54.8449 143.397C45.6469 163.155 42.4609 168.972 37.5909 174.897C28.4329 186.041 25.8969 190.438 25.8969 195.17C25.8969 197.432 25.2359 200.156 24.4289 201.224C23.6089 202.308 22.9439 205.372 22.9229 208.165C22.9029 210.915 22.3939 214.936 21.7929 217.102C20.9599 220.103 21.0099 221.978 22.0069 224.998C23.1799 228.553 23.0469 230 20.7039 239.147C16.8569 254.166 14.5339 258.878 8.38688 264.129C4.03188 267.85 2.89088 269.521 1.90888 273.617C0.77188 278.354 0.868879 278.908 3.95288 285.377C8.83488 295.614 8.84088 299.05 4.00288 313.469C-1.16212 328.865 -1.26412 332.753 3.32288 339.421C7.74888 345.856 9.27288 351.624 8.45588 358.85C7.84588 364.238 7.95788 364.658 10.4289 366.277C11.8699 367.221 14.1159 369.564 15.4189 371.483C17.6039 374.698 17.6769 375.191 16.3429 377.769C15.3289 379.731 14.8969 383.981 14.8969 392.005V403.445L20.3969 409.034C23.5409 412.228 25.8969 415.521 25.8969 416.72C25.8969 419.475 20.6479 424.665 17.8629 424.665C15.8759 424.665 15.7389 425.01 16.3769 428.415C17.3469 433.588 25.7859 455.573 28.0479 458.819C29.1219 460.362 29.8969 463.209 29.8969 465.618C29.8969 467.898 30.5459 471.019 31.3389 472.552C32.6429 475.075 32.5489 476.089 30.3449 483.233C29.0049 487.574 28.1409 491.857 28.4229 492.748C29.1079 494.905 40.1049 501.889 48.0349 505.204C57.0179 508.959 58.5289 510.644 60.3349 518.914C60.6649 520.427 61.4129 521.664 61.9979 521.664C62.5819 521.664 64.9359 523.17 67.2289 525.008C69.5209 526.847 73.1969 529.052 75.3969 529.909C79.0689 531.339 79.4049 531.782 79.4899 535.315C79.6339 541.254 79.6459 541.272 83.9389 542.558C88.3419 543.877 94.0069 550.246 101.147 561.904C104.8 567.868 104.897 568.278 104.897 577.695C104.897 586.781 105.072 587.607 107.802 591.375C110.518 595.124 111.12 595.43 117.052 596.096C120.542 596.487 131.497 598.328 141.397 600.185C151.297 602.042 163.11 604.133 167.647 604.833C175.837 606.096 177.814 607.493 174.243 609.492C170.711 611.468 168.067 609.421 241.899 661.875C253.175 669.886 264.068 677.423 266.104 678.625C270.857 681.429 348.613 697.252 350.873 695.875C351.685 695.381 353.26 692.768 354.374 690.07C358.255 680.667 357.274 681.139 368.001 683.511C373.169 684.654 383.022 686.554 389.897 687.733C410.015 691.183 410.094 691.219 412.142 697.612C413.101 700.608 415.291 704.508 417.007 706.279C418.724 708.05 423.114 713.461 426.763 718.305C432.565 726.008 437.301 730.56 443.262 734.164C445.557 735.551 448.838 745.448 450.557 756.164C453.301 773.28 456.742 777.096 487.393 797.027L491.796 799.889L495.097 797.847C500.126 794.734 503.527 790.726 506.318 784.622C510.924 774.552 517.901 770.585 525.12 773.93C526.923 774.765 532.408 776.003 537.311 776.682C544.177 777.633 546.642 778.406 548.043 780.042C549.043 781.209 554.059 786.664 559.19 792.164C568.089 801.703 568.668 802.602 571.749 811.664C577.62 828.929 581.005 835.821 586.484 841.664C589.321 844.689 592.425 848.739 593.381 850.664C594.338 852.589 596.367 855.514 597.89 857.164C600.148 859.61 600.754 861.364 601.173 866.664C601.562 871.586 602.664 875.106 605.709 881.164C607.921 885.564 610.478 891.762 611.392 894.937L613.052 900.711L627.225 907.725C637.581 912.851 642.878 914.898 646.897 915.331C651.21 915.795 653.553 916.783 657.753 919.906C662.604 923.513 663.333 923.77 665.486 922.617C670.091 920.153 672.002 917.728 670.925 915.716C670.38 914.697 668.805 909.431 667.424 904.014C664.247 891.54 664.025 881.043 666.862 877.435C667.943 876.061 669.316 872.738 669.912 870.051C671.674 862.119 676.404 853.385 680.116 851.208C681.921 850.15 685.083 847.642 687.144 845.633C689.205 843.625 692.918 840.939 695.394 839.665C699.908 837.344 700.983 835.458 698.647 833.964C697.96 833.524 696.853 832.466 696.188 831.612C695.135 830.259 695.523 830.07 699.188 830.151C702.512 830.224 703.604 830.707 704.381 832.448C705.516 834.989 706.025 834.903 716.397 830.409C726.017 826.24 736.034 819.461 744.647 811.289C751.577 804.714 753.452 801.664 750.566 801.664C748.546 801.664 746.554 797.166 747.285 794.255C747.997 791.417 752.219 788.128 753.853 789.138C754.427 789.493 754.897 790.794 754.897 792.032C754.897 793.269 755.505 795.114 756.248 796.13C757.472 797.805 758.057 797.861 762.498 796.743C765.192 796.064 771.521 793.966 776.561 792.078C781.601 790.19 788.007 788.212 790.796 787.683C795.586 786.775 796.316 786.94 803.97 790.641C812.643 794.835 820.819 796.99 826.12 796.479C828.85 796.217 829.449 795.708 829.711 793.436C829.884 791.936 831.153 789.821 832.531 788.737C835.592 786.329 838.302 787.116 844.533 792.222C846.843 794.115 849.345 795.664 850.093 795.664C850.84 795.664 852.454 796.367 853.678 797.224C855.485 798.49 855.706 799.153 854.854 800.745C853.433 803.4 854.196 804.322 860.222 807.229C868.277 811.115 871.918 811.359 875.599 808.261C879.317 805.133 881.957 804.968 884.44 807.711C886.899 810.428 890.665 809.883 893.225 806.438C895.127 803.88 895.148 803.599 893.574 801.86C889.978 797.886 892.408 795.558 896.562 798.998C898.121 800.288 900.874 801.849 902.679 802.464C906.668 803.824 914.897 810.398 914.897 812.225C914.897 814.808 917.032 814.798 920.44 812.199C922.341 810.749 923.897 808.726 923.897 807.703C923.897 805.274 918.94 801.155 914.172 799.625C905.824 796.944 904.456 792.23 910.854 788.191C915.967 784.964 918.562 780.664 915.397 780.664C914.564 780.664 913.897 779.775 913.897 778.664C913.897 776.106 913.632 776.136 907.949 779.331C902.066 782.638 899.637 782.048 900.083 777.422C900.316 775.009 900.836 774.237 902.092 774.445C903.025 774.6 905.493 773.812 907.577 772.695C909.662 771.578 911.795 770.664 912.318 770.664C912.84 770.664 914.197 769.84 915.333 768.834C918.546 765.985 924.79 764.664 935.044 764.664H944.459L945.928 760.425C946.764 758.012 948.132 756.046 949.103 755.86C951.778 755.349 956.833 761.582 956.868 765.433C956.901 769.101 955.678 769.072 968.86 765.732C974.203 764.378 975.443 763.667 976.011 761.63C976.452 760.047 976.733 759.79 976.797 760.914C976.918 763.026 977.11 763.033 983.279 761.161C987.749 759.805 989.016 759.85 998.279 761.685C1014.48 764.894 1031.45 774.502 1030.68 780.024C1030.43 781.852 1030.94 782.08 1035.4 782.12C1039.32 782.154 1041.8 781.387 1046.9 778.57C1057.25 772.846 1059.29 771.799 1061.17 771.237C1062.49 770.845 1062.79 770.077 1062.33 768.268C1060.94 762.729 1070.18 762.353 1078.47 767.612C1083.18 770.598 1093.26 781.343 1095.16 785.414C1095.74 786.651 1096.61 787.664 1097.08 787.664C1097.55 787.664 1099.89 789.464 1102.28 791.664C1104.72 793.91 1107.67 795.688 1109.01 795.719C1115.38 795.867 1118.29 807.47 1115.88 823.164C1115.21 827.564 1114.69 831.839 1114.74 832.664C1114.94 836.091 1116.58 844.68 1117.15 845.25C1118.53 846.626 1119.9 844.309 1119.9 840.605C1119.9 836.393 1121.17 835.667 1124.97 837.704C1127.34 838.972 1126.81 842.099 1123.13 848.461L1120.65 852.755L1127.97 863.461C1131.99 869.348 1135.75 874.48 1136.32 874.866C1136.89 875.252 1138.2 874.239 1139.22 872.616C1141.16 869.563 1142.93 868.731 1142.85 870.914C1142.83 871.602 1142.41 874.189 1141.92 876.664C1140.8 882.408 1142.76 886.168 1146.4 885.252C1149.41 884.498 1151.69 887.302 1155.46 896.397C1159.04 905.033 1159.55 905.664 1162.97 905.664C1164.53 905.664 1166.89 906.158 1168.21 906.763C1171.46 908.243 1180.89 919.075 1180.91 921.347C1180.93 924.405 1182.03 927.503 1183.26 927.975C1183.9 928.221 1187.35 927.75 1190.91 926.93C1194.48 926.11 1199.35 925.217 1201.74 924.944C1206.04 924.454 1206.07 924.473 1204.84 926.806C1203.62 929.134 1203.63 929.141 1205.68 927.327C1207.55 925.666 1207.7 924.651 1207.29 916.733C1206.9 909.254 1207.15 907.26 1209.02 903.07C1210.86 898.949 1211.21 896.327 1211.22 886.664C1211.23 869.433 1209.52 863.404 1200.23 847.99C1195.97 840.936 1189.89 830.01 1186.71 823.712C1181.26 812.919 1181.02 812.126 1182.45 809.945C1184.8 806.355 1182.84 801.253 1175.81 792.664C1167.43 782.422 1162.72 775.368 1158.07 766.052C1154.53 758.977 1152.78 753.985 1146.99 734.509C1146.06 731.391 1145.63 728.026 1146.03 727.009C1146.43 725.994 1146.79 723.155 1146.83 720.698C1146.86 718.242 1147.52 714.417 1148.28 712.198C1149.03 709.98 1150.62 704.948 1151.8 701.018C1152.98 697.088 1154.77 692.813 1155.78 691.518C1156.78 690.223 1158.19 687.364 1158.9 685.164C1159.61 682.964 1162.19 678.937 1164.63 676.214L1169.06 671.261L1166.48 669.38C1165.06 668.345 1163.9 667.142 1163.9 666.708C1163.9 666.274 1166.09 665.708 1168.78 665.451C1173.19 665.026 1174.59 664.173 1183.53 656.458C1188.95 651.769 1195.98 645.205 1199.15 641.872C1204.4 636.331 1204.9 635.426 1204.9 631.292C1204.9 624.494 1213.14 611.23 1221.47 604.604C1224.5 602.202 1226.12 601.664 1230.37 601.664H1235.58L1236.86 595.914C1238.64 587.878 1241.26 583.181 1247.77 576.354C1254.68 569.108 1259.29 566.642 1266.29 566.458L1271.63 566.318L1273.42 561.242C1274.41 558.45 1275.44 555.537 1275.72 554.771C1276.12 553.658 1275.19 553.479 1271.06 553.875C1265.71 554.39 1264.8 553.821 1267.45 551.622C1269.65 549.796 1268.87 545.374 1266.15 544.177C1264.64 543.518 1263.9 542.327 1263.9 540.594C1263.9 537.053 1264.36 536.8 1268.73 537.966C1275.09 539.664 1277.5 538.401 1280.96 531.548C1284.17 525.184 1284.92 519.449 1283.01 515.883C1281.6 513.24 1278.23 512.139 1276.35 513.704C1275.21 514.645 1274.57 514.638 1273.41 513.672C1272.41 512.843 1270.42 512.658 1267.41 513.11C1264.51 513.545 1262.9 513.414 1262.9 512.742C1262.9 511.557 1272.06 506.665 1274.29 506.665C1275.09 506.665 1277.8 508.237 1280.32 510.158C1282.84 512.08 1284.9 513.405 1284.9 513.104C1284.9 512.802 1283.11 509.594 1280.93 505.975C1278.74 502.355 1276.22 497.317 1275.32 494.779C1274.42 492.241 1273.21 488.89 1272.63 487.331C1270.98 482.859 1264.94 481.353 1259.67 484.1C1257.2 485.386 1256.72 485.333 1254.67 483.546L1252.4 481.569L1255.65 482.197C1260.08 483.052 1260.77 480.838 1257.54 476.096C1255.16 472.595 1255.06 471.859 1255.55 462.495L1256.07 452.595L1251.74 448.634C1247.87 445.098 1247.54 444.46 1248.67 442.663C1249.73 440.957 1249.54 439.894 1247.41 435.691C1246.03 432.963 1244.9 429.463 1244.9 427.914C1244.9 426.364 1244 422.535 1242.9 419.405C1240.54 412.688 1240.39 409.738 1242.3 407.132C1243.12 406.008 1243.49 403.946 1243.2 402.144C1242.86 400.07 1243.22 398.642 1244.3 397.746C1245.63 396.641 1245.91 396.649 1245.96 397.793C1245.99 398.547 1246.21 401.64 1246.44 404.665C1246.67 407.69 1246.9 411.612 1246.95 413.381C1247 415.149 1248.08 418.736 1249.34 421.35C1251 424.803 1251.42 426.84 1250.86 428.797C1249.68 432.89 1254 438.654 1256.61 436.485C1258.32 435.071 1260.58 436.964 1262.4 441.335C1263.45 443.845 1264.41 444.665 1266.29 444.665C1267.66 444.665 1269.02 445.05 1269.31 445.522C1269.6 445.993 1269 449.317 1267.97 452.91C1266.94 456.504 1265.86 461.911 1265.56 464.928C1265.07 469.981 1265.25 470.626 1267.85 473.121C1269.41 474.61 1270.91 475.454 1271.19 474.996C1271.46 474.538 1272.01 471.015 1272.39 467.165C1272.78 463.315 1274.17 457.748 1275.49 454.794C1276.82 451.84 1277.9 447.855 1277.9 445.939C1277.9 443.637 1278.79 441.395 1280.52 439.336C1282.95 436.45 1283.1 435.731 1282.53 429.691C1282.19 426.102 1281.91 421.937 1281.9 420.435C1281.9 418.282 1281.09 417.294 1278.07 415.754C1275.16 414.267 1273.15 411.907 1269.62 405.832C1264.61 397.216 1262.95 392.665 1264.82 392.665C1266.65 392.665 1276.18 397.69 1278.65 399.949C1279.88 401.084 1280.9 402.835 1280.9 403.839C1280.9 410.346 1288.47 398.07 1293.54 383.341C1296.78 373.919 1297.76 360.626 1295.59 355.466C1294.14 352.009 1293.82 351.804 1290.6 352.326C1288.44 352.676 1286.87 352.436 1286.41 351.688C1285.32 349.926 1287.34 348.399 1291.1 348.141C1298.5 347.633 1318.29 338.831 1330.43 330.644C1340.42 323.903 1341 322.994 1335.68 322.418C1332.55 322.079 1330.19 322.557 1326.9 324.197C1324.42 325.431 1320.28 327.197 1317.69 328.12C1315.1 329.044 1311.33 330.919 1309.31 332.286C1304.14 335.794 1296.96 338.124 1295.57 336.739C1294.79 335.958 1296.29 333.895 1300.94 329.383C1306.36 324.12 1309 322.454 1317.4 319.009C1322.9 316.752 1329.87 314.57 1332.9 314.159C1336.38 313.685 1339.93 312.361 1342.57 310.54L1346.75 307.668L1346.18 302.167C1345.79 298.383 1345.97 296.665 1346.76 296.665C1347.38 296.665 1347.9 297.82 1347.9 299.231C1347.9 302.837 1349.63 305.665 1351.85 305.665C1352.88 305.665 1355.45 303.844 1357.56 301.619C1360.58 298.429 1361.89 297.698 1363.75 298.165C1365.37 298.57 1366.52 298.19 1367.42 296.962C1369.36 294.312 1370.49 296.258 1369.12 299.887C1367.69 303.659 1368 304.107 1371.42 303.248C1373.67 302.683 1373.95 302.203 1373.43 299.817C1372.68 296.388 1374.7 294.364 1380.63 292.61C1389.02 290.129 1389.95 284.863 1383.11 278.566C1381.08 276.696 1380.42 276.319 1381.66 277.729C1384.52 281.005 1384.48 282.767 1381.49 285.573C1379.03 287.892 1372.18 289.363 1370.4 287.956C1369.85 287.521 1368.33 285.048 1367.03 282.46C1365.1 278.621 1363.91 277.502 1360.53 276.382C1355.36 274.663 1354.73 271.955 1358.32 266.781C1359.74 264.733 1360.9 262.572 1360.9 261.979C1360.9 261.386 1359.1 259.101 1356.9 256.902C1353.36 253.365 1352.97 252.514 1353.52 249.534C1353.86 247.681 1354.91 244.365 1355.85 242.165C1357.63 237.972 1360.22 228.299 1361.59 220.665C1362.32 216.579 1362.68 216.137 1365.48 215.864C1367.7 215.647 1370.2 213.902 1374.45 209.614C1377.68 206.342 1380.7 203.665 1381.16 203.665C1381.61 203.665 1383.26 202.719 1384.82 201.564L1387.66 199.462L1386.29 194.314C1384.37 187.086 1384.49 184.665 1386.78 184.665C1387.92 184.665 1389.14 185.837 1389.9 187.665C1391.37 191.212 1393.11 191.488 1395.1 188.49C1396.11 186.959 1397.09 186.524 1398.39 187.023C1399.79 187.562 1399.95 188.008 1399.06 188.898C1398.42 189.54 1397.9 190.718 1397.9 191.515C1397.9 192.313 1399.13 191.132 1400.65 188.891C1406.53 180.17 1421.42 164.584 1426.09 162.258C1429.48 160.567 1429.41 158.21 1425.83 153.227C1422.95 149.212 1422.18 148.734 1418.11 148.464C1413.02 148.126 1412.45 147.441 1411.23 140.165C1410.4 135.189 1410.38 135.162 1406.06 134.586C1403.68 134.268 1401.32 133.368 1400.82 132.586C1399.58 130.641 1397.41 124.358 1395.5 117.165C1390.66 98.9695 1388.56 91.9545 1387.4 90.1095C1386.32 88.3965 1375.31 81.6645 1373.59 81.6645C1373.3 81.6645 1370.69 83.6895 1367.79 86.1645C1361.52 91.5145 1358.59 91.9005 1356.4 87.6645C1355.54 86.0145 1354.16 84.6645 1353.32 84.6645C1351.44 84.6645 1348.12 92.0205 1344.51 104.165C1343.04 109.115 1340.57 116.325 1339.03 120.188C1337.16 124.846 1336.47 127.879 1336.98 129.189C1338.59 133.302 1337.98 143.462 1335.9 147.165C1334.8 149.123 1333.9 151.747 1333.9 152.995C1333.9 154.244 1333.52 155.692 1333.05 156.215C1332.59 156.737 1331.66 159.729 1330.99 162.863L1329.78 168.56L1325.27 168.863C1320.47 169.184 1318.68 171.011 1317.46 176.835C1317.03 178.867 1316.12 179.663 1313.65 180.163C1311.86 180.524 1301.17 183.072 1289.9 185.824C1278.62 188.577 1263.26 192.07 1255.76 193.587C1248.26 195.104 1240.61 197.23 1238.76 198.311C1234.48 200.812 1227.02 210.039 1222.86 217.996C1220.99 221.562 1216.73 227.038 1212.76 230.976C1208.99 234.722 1205.9 238.175 1205.9 238.648C1205.9 239.122 1207.47 240.03 1209.4 240.665C1213.35 241.971 1213.79 243.542 1210.93 246.136C1209.44 247.479 1209.2 248.361 1209.93 249.725C1212.24 254.049 1209.93 262.665 1206.46 262.665C1205.74 262.665 1204.58 263.34 1203.9 264.165C1203.21 264.99 1201.94 265.665 1201.07 265.665C1200.2 265.665 1195.95 267.325 1191.62 269.354C1184.08 272.893 1183.59 272.99 1179.58 271.734C1169.7 268.643 1161.51 269.368 1149.65 274.383C1145.07 276.32 1144.81 278.82 1148.42 286.165C1149.77 288.915 1150.88 291.963 1150.89 292.937C1150.91 297.143 1125.69 319.746 1113.81 326.165C1109.74 328.365 1104.53 331.872 1102.24 333.959C1099.87 336.123 1095.57 338.614 1092.24 339.758C1089.02 340.86 1083.86 343.091 1080.76 344.714C1073.7 348.407 1071.16 348.488 1069.86 345.063C1069.12 343.126 1068.43 342.644 1067.13 343.177C1063.19 344.8 1061.78 344.789 1057.2 343.103C1054.56 342.13 1052.04 341.029 1051.6 340.655C1050.6 339.798 1055.56 324.751 1057.6 322.464C1058.44 321.528 1059.28 318.692 1059.48 316.161C1059.95 310.175 1060.51 309.422 1063.93 310.173C1066.58 310.755 1066.83 310.544 1067.47 307.098C1068.61 301.031 1064.42 283.166 1058.38 268.378C1057.44 266.058 1052.76 263.665 1049.17 263.665C1045.4 263.665 1042.64 265.739 1037.94 272.102C1033.45 278.178 1030.94 279.288 1027.97 276.514C1025.29 274.018 1025.35 271.499 1028.17 267.992C1038.12 255.645 1041.3 245.211 1037.4 237.672C1036.29 235.522 1036.16 234.105 1036.9 232.165C1038.78 227.203 1036.09 224.367 1023.65 218.224C1017.45 215.167 1011.9 212.665 1011.3 212.665C1010.7 212.665 1009.41 211.79 1008.45 210.721C1007.48 209.652 1005.6 208.64 1004.26 208.471C998.11 207.695 1004.6 204.36 1011.82 204.585C1013.7 204.643 1017.51 205.362 1020.27 206.182C1023.03 207.002 1025.66 207.297 1026.13 206.836C1027.54 205.418 1025.91 202.911 1022.69 201.58C1018.66 199.912 1013.74 195.724 1014.45 194.571C1014.76 194.069 1014.71 191.635 1014.34 189.162C1013.58 184.04 1011.96 183.488 1005.55 186.165C1003.58 186.99 1000.2 187.665 998.04 187.665C994.342 187.665 994.082 187.464 993.455 184.121C993.089 182.172 993.057 179.735 993.384 178.705C994.257 175.955 992.503 175.401 986.632 176.575C983.753 177.151 977.797 178.295 973.397 179.118C966.235 180.458 965.03 181.019 961.897 184.475C959.972 186.599 957.081 188.887 955.472 189.559C952.922 190.625 952.185 190.515 949.731 188.701L946.916 186.619L945.184 188.642C941.866 192.518 938.468 191.304 932.786 184.214C925.679 175.345 919.346 173.302 914.103 178.187L911.397 180.708L911.076 177.581C910.639 173.331 916.55 164.496 921.864 161.454C926.276 158.928 927.646 156.78 925.681 155.468C923.956 154.316 920.028 155.123 914.339 157.797C910.885 159.421 908.027 162.065 903.594 167.739C898.349 174.451 897.317 175.32 895.754 174.343C894.265 173.414 893.384 173.76 890.675 176.34C888.872 178.056 884.204 181.052 880.301 182.998C876.398 184.943 871.898 187.613 870.301 188.93C866.03 192.452 864.134 192.862 858.227 191.54C851.937 190.132 851.511 188.711 855.856 183.627C858.504 180.529 859.865 176.665 858.308 176.665C857.985 176.665 853.597 178.641 848.558 181.055C836.575 186.797 826.897 189.396 826.897 186.871C826.897 186.434 833.309 179.489 841.147 171.437C855.395 156.8 858.075 154.815 869.215 150.647C872.19 149.534 875.384 147.784 876.312 146.759C877.903 145.001 877.868 144.751 875.698 142.366C873.446 139.891 873.238 139.859 865.985 140.856L858.574 141.876L855.172 138.27C853.302 136.287 851.237 134.679 850.584 134.695C849.931 134.712 846.757 136.24 843.53 138.091L837.662 141.457L832.623 137.643C829.852 135.545 826.192 133.566 824.491 133.245C822.579 132.885 820.633 131.52 819.397 129.674C817.414 126.713 814.646 125.254 807.9 123.614C805.004 122.91 803.659 123.201 800.072 125.303C797.689 126.699 795.641 127.689 795.521 127.503C795.401 127.317 794.758 125.899 794.092 124.352L792.883 121.539L789.985 123.602C786.269 126.249 784.564 126.189 778.109 123.183C775.2 121.829 771.069 120.25 768.93 119.674C764.518 118.486 763.543 116.477 762.375 106.165C761.494 98.3945 760.51 96.6645 756.969 96.6645C753.667 96.6645 752.897 98.0605 752.897 104.047C752.897 106.367 752.412 108.749 751.818 109.343C751.191 109.97 748.161 110.266 744.568 110.048C741.174 109.842 727.597 109.206 714.397 108.636C670.472 106.738 611.672 101.905 569.397 96.7175C547.908 94.0805 543.066 93.4655 525.397 91.1305C475.123 84.4865 435.622 77.5875 378.897 65.5415C351.544 59.7335 302.923 48.2195 294.761 45.6175C291.661 44.6285 287.836 43.5925 286.261 43.3145C269.464 40.3475 157.75 7.46951 139.748 0.194514C138.841 -0.172486 137.81 -0.00449175 137.457 0.566508ZM125.564 9.33152C125.197 9.69752 124.897 10.8225 124.897 11.8315C124.897 13.7715 127.352 14.3555 128.397 12.6645C129.387 11.0615 130.622 11.5045 131.187 13.6645C131.867 16.2645 133.584 16.2255 134.42 13.5915C134.867 12.1845 134.487 11.0695 133.238 10.1225C131.31 8.66251 126.707 8.18752 125.564 9.33152ZM897.397 139.787C889.282 145.842 887.602 147.665 890.136 147.665C891.672 147.665 905.976 138.115 907.081 136.352C907.816 135.18 907.221 133.616 906.088 133.742C905.708 133.784 901.797 136.505 897.397 139.787ZM1029.56 199.332C1027.57 201.327 1029.99 205.951 1032.52 204.98C1034.22 204.329 1034.31 201.483 1032.7 199.865C1031.34 198.506 1030.53 198.368 1029.56 199.332ZM980.428 203.368C978.796 203.628 976.237 204.711 974.742 205.775C973.247 206.84 968.958 209.102 965.211 210.804C961.357 212.553 957.043 215.428 955.279 217.422C951.613 221.566 949.795 221.071 950.594 216.147C951.184 212.508 949.73 211.353 948.139 214.197C947.668 215.039 945.744 216.502 943.865 217.447C941.159 218.808 940.028 220.335 938.423 224.798C937.309 227.896 935.863 231.058 935.21 231.825C933.31 234.055 923.897 252.729 923.897 254.267C923.897 256.816 926.008 255.722 930.729 250.725C938.082 242.942 941.549 238.374 942.227 235.577C943.085 232.032 946.933 227.301 948.049 228.417C948.948 229.316 947.224 234.653 944.366 239.819C943.558 241.279 942.897 243.359 942.897 244.442C942.897 245.524 941.772 249.856 940.397 254.068C939.022 258.28 937.897 263.754 937.897 266.231C937.897 268.717 937.164 271.854 936.261 273.232C935.038 275.098 934.777 277.007 935.227 280.802C935.705 284.843 935.326 287.109 933.362 291.943C930.113 299.94 930.239 305.3 933.961 317.292C936.138 324.305 936.858 328.256 936.447 330.931C935.974 334.011 936.526 335.925 939.479 341.431C943.95 349.769 946.561 352.665 949.605 352.665C951.93 352.665 959.77 349.003 963.112 346.355C966.857 343.387 971.897 326.486 971.897 316.893C971.897 311.687 968.482 300.487 964.392 292.28C961.638 286.752 961.374 284.463 962.966 279.896C963.68 277.849 963.717 275.672 963.077 273.356C962.333 270.659 962.505 269.022 963.852 266.015C966.231 260.701 967.171 255.046 966.031 252.915C964.686 250.402 967.179 244.949 970.329 243.514C971.72 242.88 973.109 241.573 973.414 240.61C974.537 237.072 984.301 227.853 987.296 227.503C991.648 226.995 992.69 224.552 990.382 220.268L988.472 216.721L992.738 213.069C998.067 208.508 998.122 205.513 992.897 204.541C985.093 203.088 983.27 202.917 980.428 203.368ZM980.897 213.665C980.897 214.215 981.572 214.665 982.397 214.665C983.222 214.665 983.897 214.215 983.897 213.665C983.897 213.115 983.222 212.665 982.397 212.665C981.572 212.665 980.897 213.115 980.897 213.665ZM980.747 236.665C980.664 238.315 980.552 240.19 980.497 240.832C980.442 241.473 980.96 242.186 981.647 242.415C982.526 242.708 982.897 241.471 982.897 238.248C982.897 233.228 980.989 231.823 980.747 236.665ZM1379.49 301.169C1377.3 302.826 1377.86 303.143 1384.65 304.093C1389.88 304.826 1390.66 302.474 1385.75 300.763C1381.85 299.405 1381.82 299.407 1379.49 301.169ZM21.8969 369.724C21.8969 370.306 22.3469 370.505 22.8969 370.165C23.4469 369.825 23.8969 369.348 23.8969 369.105C23.8969 368.862 23.4469 368.665 22.8969 368.665C22.3469 368.665 21.8969 369.142 21.8969 369.724ZM19.6819 374.809C18.8349 377.352 21.4219 392.013 22.7989 392.469C23.9009 392.834 24.0519 392.209 23.5059 389.548C23.1229 387.687 22.5399 383.353 22.2089 379.915C21.6539 374.145 20.6079 372.031 19.6819 374.809ZM25.4889 514.164C27.0489 516.544 29.8969 517.615 29.8969 515.82C29.8969 514.609 26.4589 511.665 25.0449 511.665C24.2379 511.665 24.3819 512.474 25.4889 514.164ZM34.3429 515.751C33.9739 516.349 34.1169 517.284 34.6619 517.829C36.8259 519.993 49.8969 521.672 49.8969 519.785C49.8969 518.797 46.3449 517.277 40.3969 515.722C35.4119 514.417 35.1669 514.419 34.3429 515.751ZM1294.78 533.164C1294.18 537.161 1294.4 538.499 1295.46 537.432C1295.77 537.12 1295.88 535.132 1295.7 533.014L1295.37 529.164L1294.78 533.164ZM71.4509 548.576C70.5169 550.089 73.6929 555.664 75.4889 555.664C76.5669 555.664 76.9349 554.872 76.7129 553.027C76.3649 550.121 72.5109 546.861 71.4509 548.576ZM64.8969 565.091C64.8969 567.202 67.6799 572.664 68.7559 572.664C71.3749 572.664 69.9069 567.577 66.4629 564.719C65.1479 563.627 64.8969 563.687 64.8969 565.091ZM882.12 768.221C879.366 770.149 879.207 774.226 881.831 775.63C886.757 778.266 899.897 775.321 899.897 771.581C899.897 767.306 886.926 764.854 882.12 768.221ZM835.897 793.583C835.897 796.215 837.356 797.664 840.004 797.664C843.462 797.664 843.717 796.352 840.674 794.221C838.199 792.487 835.897 792.18 835.897 793.583ZM682.897 842.557C682.897 843.661 685.492 844.736 686.272 843.956C686.586 843.642 686.603 842.999 686.311 842.526C685.609 841.39 682.897 841.414 682.897 842.557ZM1173.4 946.664C1173.06 947.214 1173.48 947.664 1174.34 947.664C1175.19 947.664 1175.9 947.214 1175.9 946.664C1175.9 946.114 1175.47 945.664 1174.96 945.664C1174.44 945.664 1173.74 946.114 1173.4 946.664ZM1160.4 950.664C1159.61 951.937 1161.93 951.937 1163.9 950.664C1165.12 949.876 1164.99 949.693 1163.21 949.68C1162 949.672 1160.74 950.114 1160.4 950.664Z";

// Cache canvas context and path for better performance
let cachedContext: CanvasRenderingContext2D | null = null;
let cachedPath: Path2D | null = null;

const getPathContext = () => {
  if (typeof document === 'undefined') return null;
  
  if (!cachedContext || !cachedPath) {
    const canvas = document.createElement('canvas');
    cachedContext = canvas.getContext('2d');
    cachedPath = new Path2D(USA_PATH_DATA);
  }
  
  return { ctx: cachedContext, path: cachedPath };
};

// Parse path data and convert to polygon points for hit testing
const isPointInUSA = (x: number, y: number): boolean => {
  const { ctx, path } = getPathContext() || {};
  
  if (!ctx || !path) {
    return true; // Fallback: show all squares if we can't test
  }
  
  // Scale coordinates from our 800x500 viewBox to the original 1429x952 path
  const scaledX = (x / 800) * 1429;
  const scaledY = (y / 500) * 952;
  
  return ctx.isPointInPath(path, scaledX, scaledY);
};

// Generate simple grid of squares with USA mask
// Only returns visible squares (inside USA) to reduce DOM nodes
const generateSimpleGrid = () => {
  const squares = [];
  
  // Generate a full rectangular grid
  // SVG viewBox is 0 0 800 500
  for (let y = 0; y <= 500; y += GRID_SPACING) {
    for (let x = 0; x <= 800; x += GRID_SPACING) {
      // Check if square's center is inside USA shape
      const isInside = isPointInUSA(x, y);
      
      // Skip squares outside USA to reduce rendering load
      if (!isInside) continue;
      
      // All squares use the default opacity
      squares.push({ x, y, opacity: SQUARE_OPACITY });
    }
  }
  
  return squares;
};

export default function MarketsSection() {
  const [isMounted, setIsMounted] = useState(false);

  useEffect(() => {
    setIsMounted(true);
  }, []);

  // Memoize grid generation - only compute once after mount
  const gridSquares = useMemo(() => {
    if (!isMounted) return [];
    return generateSimpleGrid();
  }, [isMounted]);
  return (
    <section data-theme="dark" id="markets" className="bg-[#0a0a0a] relative overflow-hidden py-16 sm:py-24 md:py-32 flex items-center justify-center min-h-[80vh] sm:min-h-[90vh] md:h-[100vh]">
      
      {/* Absolute Positioned Map Background */}
      <div className="absolute inset-0 flex items-center justify-center">
        <div className="w-full max-w-[110vw] h-full flex items-center justify-center">
          <div className="w-full h-full bg-[#0a0a0a] flex items-center justify-center">
            <svg
              viewBox="0 0 800 500"
              className="w-full h-auto max-h-full"
              preserveAspectRatio="xMidYMid meet"
              xmlns="http://www.w3.org/2000/svg"
            >
              {/* Simple Square Grid */}
              <g id="square-grid">
                {gridSquares.map((square, index) => (
                  <rect
                    key={`square-${index}`}
                    x={square.x - SQUARE_SIZE / 2}
                    y={square.y - SQUARE_SIZE / 2}
                    width={SQUARE_SIZE}
                    height={SQUARE_SIZE}
                    fill="white"
                    opacity={square.opacity}
                  />
                ))}
              </g>
            </svg>
          </div>
        </div>
      </div>

      {/* Centered Content Container */}
      <div className="relative z-10 max-w-7xl mx-auto px-6 lg:px-8 flex items-center justify-center">
        <div className="max-w-[600px] text-center">
          <div className="line-accent mb-6 mx-auto" />
          <WipeReveal
            as="h2"
            className="font-display text-4xl md:text-5xl lg:text-6xl tracking-tight leading-[0.8] mb-6"
            theme="light"
            delay={0}
          >
            CURRENT MARKETS &
          </WipeReveal> <br />
          <WipeReveal
            as="h2"
            className="font-display text-4xl md:text-5xl lg:text-6xl tracking-tight leading-[0.8] mb-6"
            theme="light"
            delay={0}
          >
            MARKET EXPANSION
          </WipeReveal> <br />
          <WipeReveal
            as="p"
            className="text-lg text-white/70 mb-6 leading-relaxed uppercase tracking-wide"
            theme="light"
            delay={150}
          >
            RIVVIA CURRENTLY OPERATES IN 22 MARKETS ACROSS THE COUNTRY, AND CONSISTENTLY OPENS NEW MARKETS EACH QUARTER. 
          </WipeReveal> <br />
          <WipeReveal
            as="p"
            className="text-white/60 mb-8"
            theme="light"
            delay={300}
          >
            Each market is strategically picked for Fiber adoption to ensure the highest close rate possible.
          </WipeReveal>
        </div>
      </div>
    </section>
  );
}
